<!DOcTYPE html>

<html>
	<head>
		<title>test</title>

		<style>
			body {
				display: flex;
				flex-wrap: wrap;
			}
			.card {
				position: relative;
				display: flex;
				align-items: center;
				justify-content: center;
				margin: 2rem;
				width: 20rem;
				height: 10rem;
				font-size: 200%;
				box-shadow: 3px 3px 3px gray;
			}
			.graph {
				position: absolute;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
			}
			.graph path {
				stroke: gray;
				stroke-width: 2;
				fill: none;
			}
		</style>

		<script src="https://d3js.org/d3.v4.min.js"></script>
	</head>

	<body>
		<div class="card" id=current_temp>
			<div><span></span>â„ƒ</div>
			<svg class="graph"></svg>
		</div>
		<div class="card" id=current_humid>
			<div><span></span>%</div>
			<svg class="graph"></svg>
		</div>
	</body>

	<script>
		function get(endpoint, func) {
			var xhr = new XMLHttpRequest();
			xhr.onreadystatechange = () => {
				if (xhr.readyState == 4 && (xhr.status == 200 || xhr.status == 304)) func(xhr.response);
			};
			xhr.open('GET', `http://${location.host}${endpoint}`);
			xhr.responseType = 'json';
			xhr.send();
		}

		var data = [];
		data.appendAll = xs => {
			xs.filter(x => data.filter(y => x.timestamp == y.timestamp)).forEach(x => data.push(x));
			data.sort((x, y) => x.timestamp - y.timestamp);
		};

		data.update = (callback, limit=2) => {
			get('/api/temphumid?limit=' + limit, res => {
				if (res.error) {
					alert(res.error);
					return;
				}

				data.appendAll(res.data);
				callback();
			});
		};

		function graphUpdate() {
			document.querySelectorAll('.graph').forEach(x => {
				x.innerHTML = '';
				x.width = x.clientWidth;
				x.height = x.clientHeight;
			});

			const gd = data.slice(Math.max(0, data.length - 12*12));

			var elm = document.querySelector('#current_temp .graph');
			d3.select('#current_temp .graph')
				.append('path')
				.attr('d', d3.line()
					.x(d => (d.timestamp - gd[0].timestamp) * elm.clientWidth / (gd[gd.length - 1].timestamp - gd[0].timestamp))
					.y(d => elm.clientHeight - d.temp * elm.clientHeight / 40)
					.curve(d3.curveCardinal)(gd));

			var elm = document.querySelector('#current_humid .graph');
			d3.select('#current_humid .graph')
				.append('path')
				.attr('d', d3.line()
					.x(d => (d.timestamp - gd[0].timestamp) * document.querySelector('#current_humid .graph').clientWidth / (gd[gd.length - 1].timestamp - gd[0].timestamp))
					.y(d => elm.clientHeight - d.humid * elm.clientHeight)
					.curve(d3.curveCardinal)(gd));
		}

		function update() {
			data.update(() => {
				const last = data[data.length - 1];
				document.querySelector('#current_temp span').innerText = last.temp.toFixed(1);
				document.querySelector('#current_humid span').innerText = (last.humid * 100).toFixed(0);

				graphUpdate();
			});
		}

		window.addEventListener('resize', graphUpdate);

		update();
		setInterval(update, 5 * 60 * 1000);

		data.update(graphUpdate, 12*12);
	</script>
</html>
