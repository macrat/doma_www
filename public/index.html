<!DOcTYPE html>

<html>
	<head>
		<title>test</title>

		<style>
			body {
				display: flex;
				flex-wrap: wrap;
			}
			.card {
				display: flex;
				align-items: center;
				justify-content: center;
				margin: 2rem;
				width: 20rem;
				height: 10rem;
				font-size: 200%;
				box-shadow: 3px 3px 3px gray;
			}
		</style>
	</head>

	<body>
		<div class="card" id=current_temp><div><span></span>â„ƒ</div></div>
		<div class="card" id=current_humid><div><span></span>%</div></div>
	</body>

	<script>
		function get(endpoint, func) {
			var xhr = new XMLHttpRequest();
			xhr.onreadystatechange = () => {
				if (xhr.readyState == 4 && (xhr.status == 200 || xhr.status == 304)) {
					func(xhr.response);
				}
			};
			xhr.open('GET', `http://${location.host}${endpoint}`);
			xhr.responseType = 'json';
			xhr.send();
		}

		var data = [];
		data.appendAll = xs => xs.filter(x => data.filter(y => x.timestamp == y.timestamp)).forEach(x => data.push(x));

		data.update = callback => {
			get('/api/temphumid', res => {
				if (res.error) {
					alert(res.error);
					return;
				}

				data.appendAll(res.data);
				callback();
			});
		};

		function update() {
			data.update(() => {
				var last = data[data.length - 1];
				document.querySelector('#current_temp span').innerText = last.temp.toFixed(1);
				document.querySelector('#current_humid span').innerText = (last.humid * 100).toFixed(0);
			});
		}

		update();
		setInterval(update, 5 * 60 * 1000);
	</script>
</html>
